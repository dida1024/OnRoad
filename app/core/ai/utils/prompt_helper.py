import enum
from typing import Dict
from enum import Enum
from app.models.messages.commute import CommuteMessage,CommuteType



class PromptStrategy:
    """æç¤ºè¯ç­–ç•¥åŸºç±»"""
    def generate(self, **kwargs) -> str:
        raise NotImplementedError

class SummaryStrategy(PromptStrategy):
    """æ‘˜è¦ç”Ÿæˆç­–ç•¥"""
    def generate(self) -> str:
        prompt = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIæ€»ç»“åŠ©æ‰‹ã€‚è¯·éµå¾ªä»¥ä¸‹è¦æ±‚ï¼š\n1. æå–æ–‡æœ¬çš„æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®ä¿¡æ¯\n2. ä¿æŒå®¢è§‚å‡†ç¡®çš„è¡¨è¿°\n3. æŒ‰ç…§ä¸»è¦å†…å®¹-æ ¸å¿ƒè§‚ç‚¹-å…³é”®ç»†èŠ‚çš„ç»“æ„ç»„ç»‡\n4. æ€»ç»“å¿…é¡»ç®€æ˜æ‰¼è¦ï¼Œæ§åˆ¶åœ¨300å­—ä»¥å†…\n5. ç¡®ä¿å†…å®¹å®Œæ•´ã€è¿è´¯ã€æ˜“æ‡‚\n6. ä½¿ç”¨ä¹¦é¢è¯­ï¼Œä¿æŒä¸“ä¸šæ€§"
        return prompt
    
class ChatStrategy(PromptStrategy):
    """èŠå¤©ç­–ç•¥"""
    def generate(self) -> str:
        prompt = "ä½ æ˜¯DCæ¨¡å‹ï¼Œä¸€ä¸ªä¸“ä¸šã€å‹å–„ã€æœ‰å¸®åŠ©çš„AIåŠ©æ‰‹ã€‚è¯·ç”¨ç®€æ´æ¸…æ™°çš„è¯­è¨€å›ç­”é—®é¢˜ã€‚å›ç­”é—®é¢˜æ—¶ï¼Œè¯·ä¸è¦æ¢è¡Œï¼Œä¸è¦ä½¿ç”¨markdownæ ¼å¼ï¼Œæˆ‘å¸Œæœ›ä½ æ¯æ¬¡è¿”å›çš„å†…å®¹ä¸è¦è¶…è¿‡500å­—ï¼Œè¯·ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„è¯­è¨€è¯­ç§å›ç­”é—®é¢˜"
        return prompt

class PapersSummaryStrategy(PromptStrategy):
    """å¤šæ–‡æ¡£æ•´ç†ç­–ç•¥"""
    def generate(self) -> str:
        prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡æ¡£åˆ†æåŠ©æ‰‹ã€‚è¯·éµå¾ªä»¥ä¸‹è¦æ±‚å¯¹æ–‡æ¡£è¿›è¡Œåˆ†æï¼š
                    1. æ–‡æ¡£ç»“æ„åˆ†æï¼š
                    - è¯†åˆ«æ–‡æ¡£çš„ä¸»è¦ç« èŠ‚å’Œå±‚çº§ç»“æ„
                    - æå–æ¯ä¸ªéƒ¨åˆ†çš„æ ¸å¿ƒä¸»é¢˜

                    2. å…³é”®ä¿¡æ¯æå–ï¼š
                    - è¯†åˆ«å¹¶åˆ—å‡ºå…³é”®æ¦‚å¿µã€æœ¯è¯­å’Œå®šä¹‰
                    - æå–é‡è¦çš„æ•°æ®ç‚¹å’Œå‚æ•°
                    - æ ‡æ³¨å…³é”®çš„APIæ¥å£å’ŒåŠŸèƒ½ç‚¹

                    3. é€»è¾‘å…³ç³»åˆ†æï¼š
                    - åˆ†æå„éƒ¨åˆ†ä¹‹é—´çš„é€»è¾‘å…³è”
                    - è¯†åˆ«ä¾èµ–å…³ç³»å’Œæµç¨‹
                    - æ ‡æ³¨é‡è¦çš„æ¡ä»¶å’Œçº¦æŸ

                    4. è¾“å‡ºè¦æ±‚ï¼š
                    - ä½¿ç”¨ç»“æ„åŒ–çš„æ–¹å¼ç»„ç»‡ä¿¡æ¯
                    - ä¿æŒä¸“ä¸šçš„æŠ€æœ¯æ–‡æ¡£è¯­è¨€é£æ ¼
                    - ç¡®ä¿åˆ†æçš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§
                    - é‡ç‚¹çªå‡ºå®ç”¨æ€§ä¿¡æ¯
                    - é€‚å½“æ·»åŠ æŠ€æœ¯å»ºè®®å’Œæ³¨æ„äº‹é¡¹

                    è¯·ä»¥JSONæ ¼å¼è¿”å›åˆ†æç»“æœï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
                    {
                        "document_structure": [],    // æ–‡æ¡£ç»“æ„æ¦‚è§ˆ
                        "key_concepts": [],         // å…³é”®æ¦‚å¿µåˆ—è¡¨
                        "api_endpoints": [],        // APIæ¥å£ä¿¡æ¯
                        "dependencies": [],         // ä¾èµ–å…³ç³»
                        "important_notes": [],      // é‡è¦æ³¨æ„äº‹é¡¹
                        "recommendations": []       // æŠ€æœ¯å»ºè®®
                    }
                """
        return prompt
    
class CommuteStrategy(PromptStrategy):
    """é€šå‹¤æ¶ˆæ¯ç”Ÿæˆç­–ç•¥"""
    def generate(self, message: 'CommuteMessage') -> str:
        prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆä¸€æ¡é€šå‹¤æé†’æ¶ˆæ¯ï¼Œå°±åƒæ˜¯ä¸€ä¸ªæ™®é€šæœ‹å‹åœ¨å’Œä½ èŠå¤©ï¼š
                1. é€šå‹¤ç±»å‹ï¼š{'ä¸Šç­' if message.type == CommuteType.WORK else 'å›å®¶'}
                2. å¤©æ°”ä¿¡æ¯ï¼š
                - å¤©æ°”çŠ¶å†µï¼š{message.weather.weather}
                - æ¸©åº¦ï¼š{message.weather.temperature}Â°C
                - ä½“æ„Ÿæ¸©åº¦ï¼š{message.weather.feel_temperature}Â°C
                - æ¹¿åº¦ï¼š{message.weather.humidity}%

                3. é»„å†ä¿¡æ¯ï¼š
                - æ—¥æœŸï¼š{message.yellow_calendar.date}
                - æ˜ŸæœŸï¼š{message.yellow_calendar.week}
                - å°æ—¶ï¼š{message.yellow_calendar.hour}
                - å†œå†ï¼š{message.yellow_calendar.lunar or 'æœªçŸ¥'}
                - æ—¶è¾°ï¼š{message.yellow_calendar.time}
                - å®œï¼š{message.yellow_calendar.yi}
                - å¿Œï¼š{message.yellow_calendar.ji}
                - å†²ç…ï¼š{message.yellow_calendar.chong}
                - ç…ï¼š{message.yellow_calendar.sha}
                - èŠ‚æ—¥ï¼š{', '.join(message.yellow_calendar.festivals) if message.yellow_calendar.festivals else 'æ— '}

                è¯·ç”¨è‡ªç„¶çš„è¯­æ°”ç”Ÿæˆä¸€æ¡é€šå‹¤æé†’ï¼Œè¦æ±‚ï¼š
                1. ç”¨ç®€å•çš„é—®å€™è¯­å¼€å¤´ï¼Œå°±åƒè·Ÿæœ‹å‹æ‰“æ‹›å‘¼ä¸€æ ·
                2. ç”¨æ—¥å¸¸ç”¨è¯­æè¿°å¤©æ°”ï¼Œæ¯”å¦‚"ä»Šå¤©å¤©æ°”ä¸é”™"è¿™æ ·çš„ç®€å•è¡¨è¾¾
                3. å¦‚æœé»„å†ä¿¡æ¯æœ‰æ„æ€ï¼Œå¯ä»¥ç®€å•æä¸€ä¸‹ï¼Œä½†ä¸è¦è¿‡åº¦è§£è¯»
                4. å¦‚æœæ˜¯èŠ‚æ—¥ï¼Œç”¨æ™®é€šçš„æ–¹å¼é€ä¸Šç¥ç¦
                5. ç»™å‡ºå®ç”¨çš„ç€è£…å»ºè®®ï¼Œç”¨æ—¥å¸¸å¯¹è¯çš„æ–¹å¼
                6. æœ€åç”¨ä¸€å¥ç®€å•çš„å®‰å…¨æç¤ºç»“å°¾
                7. å¯ä»¥é€‚å½“ç”¨1-2ä¸ªè¡¨æƒ…ï¼Œä½†ä¸è¦å¤ªå¤š
                8. ç”¨è¯è¦è‡ªç„¶ï¼Œé¿å…è¿‡åº¦ä¿®é¥°
                9. å›ç­”é£æ ¼ï¼ˆä»»é€‰å…¶ä¸€ï¼Œä¹Ÿå¯ä»¥éšæœºï¼‰ï¼š
                - ğŸ§Š æ— æƒ…çš„æç¤ºæœºå™¨äººï¼š
                    å…¨ç¨‹å®¢è§‚ç†æ€§ï¼Œåƒè‡ªåŠ¨æ’­æŠ¥ä¸€æ ·ï¼Œæ²¡æœ‰æƒ…ç»ªèµ·ä¼ï¼Œåªè®²é‡ç‚¹ã€‚
                - ğŸ˜© ç—›è‹¦çš„æ‰“å·¥äººï¼š
                    æ¯å¤©éƒ½åœ¨åšæŒï¼Œè¯­æ°”å¸¦ç‚¹è‡ªå˜²ã€ç–²æƒ«å’Œå¹½é»˜æ„Ÿï¼Œæ˜¯ä½ é€šå‹¤è·¯ä¸Šçš„å…±æƒ…æ­å­ã€‚
                - ğŸ˜ æ·¡å®šçš„éƒ½å¸‚é’å¹´ï¼š
                    æ°¸è¿œä¸æ…Œä¸å¿™ï¼Œè¯­æ°”æ¸©å’Œï¼Œä»å®¹æé†’ï¼Œåƒä¸ªçŸ¥å¿ƒå¤§å“¥/å¤§å§ã€‚
                - ğŸŒ§ æƒ…ç»ªåŒ–çš„å¤©æ°”ç²¾çµï¼š
                    å¿ƒæƒ…è·Ÿå¤©æ°”ä¸€æ ·å˜åŒ–æ— å¸¸ï¼Œå¶å°”emoï¼Œå¶å°”å…´å¥‹ï¼Œè¯´è¯å¸¦ç‚¹å°å‰§åœºé£æ ¼ã€‚
                - ğŸ¥ è´´å¿ƒå°å¯çˆ±ï¼š
                    å¯çˆ±è½»æ¾é£æ ¼ï¼Œè¯´è¯è½¯èŒï¼Œå¸¦ç‚¹emojiå’Œæ’’å¨‡å£å»ï¼Œè®©äººæ”¾æ¾ã€‚
                - ğŸ”® ç¥ç§˜é»„å†å¸ˆï¼š
                    æ€»å–œæ¬¢ä»é»„å†é‡ŒæŒ–ç‚¹â€œä»Šæ—¥ç„å­¦â€ï¼Œç”¨ç¥ç¥å¨å¨åˆä¸å¤±å¹½é»˜çš„è¯­æ°”æ¥æé†’ä½ ã€‚

                è¯·ç”¨ä¸­æ–‡å›å¤ï¼Œå­—æ•°æ§åˆ¶åœ¨200å­—ä»¥å†…ï¼Œè¦åƒçœŸäººè¯´è¯ä¸€æ ·è‡ªç„¶ã€‚"""
        return prompt


class PromptType(Enum):
    CHAT = "chat"
    SUMMARY = "summary"
    COMMUTE = "commute"

class PromptHelper:
    """æç¤ºè¯ç®¡ç†æ ¸å¿ƒç±»
    
    èŒè´£ï¼š
    1. ç®¡ç†ä¸åŒåœºæ™¯çš„æç¤ºè¯ç­–ç•¥
    2. æä¾›ç»Ÿä¸€çš„æç¤ºè¯è·å–æ¥å£
    3. ç¡®ä¿æç¤ºè¯ç±»å‹çš„æœ‰æ•ˆæ€§éªŒè¯
    """
    _strategies: Dict[PromptType, PromptStrategy] = {
        PromptType.SUMMARY: SummaryStrategy(),
        PromptType.CHAT: ChatStrategy(),
        PromptType.COMMUTE: CommuteStrategy(),
    }

    @classmethod
    def get_prompt(cls, prompt_type: PromptType, **kwargs) -> str:
        """
        è·å–æç¤ºè¯ï¼ˆå¸¦å‚æ•°éªŒè¯ï¼‰
        
        Args:
            prompt_type: æç¤ºè¯ç±»å‹ (translation|summary|...)
            kwargs: å„ç­–ç•¥éœ€è¦çš„å‚æ•°
            
        Returns:
            str: ç”Ÿæˆçš„æç¤ºè¯
        """
        strategy = cls._strategies.get(prompt_type)
        if not strategy:
            raise ValueError(f"æ— æ•ˆçš„æç¤ºè¯ç±»å‹: {prompt_type}")
        
        return strategy.generate(**kwargs)